  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Process Images and JSON
        run: |
          # 1. Читаем types.json
          TYPES_CONTENT=$(cat types.json | jq -c '.')
          
          # 2. Собираем ВСЕ файлы из папки images для переменной __ALL_FILES__
          # (Твой JS код в шаблоне ожидает плоский список всех файлов .enc)
          ALL_FILES=$(find images -type f -name "*.enc" -printf "%f\n" | jq -R -s -c 'split("\n") | map(select(length > 0))')

          # 3. Подготовка index.html из шаблона
          cp index.template.html index.html

          # 4. ВСТАВКА ДАННЫХ (Самый важный момент!)
          # Вставляем ПИН-код из секретов GitHub
          sed -i "s|__PIN_HASH__|${{ secrets.PIN_HASH }}|g" index.html
          
          # Вставляем типы (категории)
          sed -i "s|__TYPES_JSON__|$TYPES_CONTENT|g" index.html
          
          # Вставляем список всех файлов
          sed -i "s|__ALL_FILES__|$ALL_FILES|g" index.html

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Build: Updated images, categories and security"
          file_pattern: 'index.html'

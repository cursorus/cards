name: Build site

on:
  push:
    branches:
      - main
    paths:
      - "images/**"
      - "types.json"
      - "index.template.html"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Process Images and JSON
        run: |
          # 1. Читаем types.json для вставки в JS
          TYPES_CONTENT=$(cat types.json | jq -c '.')
          
          # 2. Создаем пустой JSON объект для списка картинок
          echo "{}" > images_list.json
          
          # 3. Обходим все папки внутри images и собираем файлы
          for dir in images/*/; do
            folder=$(basename "$dir")
            # Собираем список файлов в этой папке
            files=$(ls "$dir" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            # Добавляем в общий список
            jq --arg key "$folder" --argjson val "$files" '.[$key] = $val' images_list.json > tmp.json && mv tmp.json images_list.json
          done
          
          IMAGES_DATA=$(cat images_list.json | jq -c '.')

          # 4. Вставляем данные в шаблон
          sed "s|__IMAGES_DATA__|$IMAGES_DATA|g" index.template.html > index.html
          # Используем другой разделитель для JSON, чтобы не конфликтовать с кавычками
          sed -i "s|__TYPES_JSON__|$TYPES_CONTENT|g" index.html

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Build: Updated images and categories"
          file_pattern: 'index.html'

name: Build and Deploy Private Cards

on:
  push:
    branches:
      - main
    paths:
      - "images/**"
      - "types.json"
      - "index.template.html"
      - ".github/workflows/build.yml"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get install jq -y

      - name: Process Site Data
        env:
          # Берем ПИН из секретов репозитория
          SITE_PIN: ${{ secrets.SITE_PIN }}
        run: |
          # 1. Создаем SHA-256 хэш пароля для проверки на фронтенде
          PIN_HASH=$(echo -n "$SITE_PIN" | sha256sum | cut -d' ' -f1)
          echo "Hash generated"

          # 2. Читаем категории из types.json (валидация через jq)
          TYPES_JSON=$(cat types.json | jq -c '.')

          # 3. Собираем список всех файлов в папке images
          # Если папки нет, создаем пустую, чтобы скрипт не падал
          mkdir -p images
          ALL_FILES=$(ls images | jq -R -s -c 'split("\n") | map(select(length > 0))')

          # 4. Используем Python для безопасной замены меток в шаблоне
          # Это гарантирует, что спецсимволы в JSON не сломают сборку
          python3 -c "
import os

with open('index.template.html', 'r', encoding='utf-8') as f:
    template = f.read()

# Заменяем метки на реальные данные
output = template.replace('__PIN_HASH__', '$PIN_HASH')
output = output.replace('__TYPES_JSON__', '$TYPES_JSON')
output = output.replace('__ALL_FILES__', '$ALL_FILES')

with open('index.html', 'w', encoding='utf-8') as f:
    f.write(output)
"
          echo "index.html successfully generated"

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "System: Rebuild index.html with new data"
          file_pattern: 'index.html'
          push_options: '--force'

name: Build and Deploy Private Cards

on:
  push:
    branches:
      - main
    paths:
      - "images/**"
      - "types.json"
      - "index.template.html"
      - ".github/workflows/build.yml"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Process Site Data
        env:
          # Передаем секрет и данные через ENV для безопасности и стабильности
          SITE_PIN: ${{ secrets.SITE_PIN }}
        run: |
          # 1. Генерируем хэш
          PIN_HASH=$(echo -n "$SITE_PIN" | sha256sum | cut -d' ' -f1)
          
          # 2. Собираем данные в переменные для Python
          TYPES_JSON=$(cat types.json | jq -c '.')
          mkdir -p images
          ALL_FILES=$(ls images | jq -R -s -c 'split("\n") | map(select(length > 0))')
          
          # Экспортируем их, чтобы Python увидел их как env-переменные
          echo "FINAL_PIN_HASH=$PIN_HASH" >> $GITHUB_ENV
          echo "FINAL_TYPES_JSON=$TYPES_JSON" >> $GITHUB_ENV
          echo "FINAL_ALL_FILES=$ALL_FILES" >> $GITHUB_ENV

      - name: Inject data with Python
        run: |
          python3 -c "
          import os
          
          # Достаем данные из окружения
          pin_hash = os.getenv('FINAL_PIN_HASH')
          types_json = os.getenv('FINAL_TYPES_JSON')
          all_files = os.getenv('FINAL_ALL_FILES')
          
          with open('index.template.html', 'r', encoding='utf-8') as f:
              content = f.read()
          
          # Безопасно заменяем метки
          content = content.replace('__PIN_HASH__', pin_hash)
          content = content.replace('__TYPES_JSON__', types_json)
          content = content.replace('__ALL_FILES__', all_files)
          
          with open('index.html', 'w', encoding='utf-8') as f:
              f.write(content)
          "

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "System: Rebuild index.html"
          file_pattern: 'index.html'

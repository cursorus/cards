name: Build site

on:
  push:
    branches:
      - main
    paths:
      - "images/**"
      - "types.json"
      - "index.template.html"
  workflow_dispatch: # Кнопка для ручного запуска

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Process and Inject Data
        env:
          # Вытягиваем секрет из настроек GitHub
          RAW_PIN_HASH: ${{ secrets.PIN_HASH }}
        run: |
          # 1. Подготовка данных
          # Читаем категории из types.json
          TYPES_CONTENT=$(cat types.json | jq -c '.')
          
          # Собираем все .enc файлы в один плоский список (JSON массив)
          ALL_FILES=$(find images -type f -name "*.enc" -printf "%f\n" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          
          # 2. Создаем чистый index.html из шаблона
          cp index.template.html index.html

          # 3. Вставка данных (используем разделитель | или @)
          # Вставляем ПИН-ХЭШ. Если в секрете пусто, подставится пустая строка
          sed -i "s|__PIN_HASH__|$RAW_PIN_HASH|g" index.html
          
          # Вставляем JSON типы (используем @, так как в JSON много кавычек)
          sed -i "s@__TYPES_JSON__@$TYPES_CONTENT@g" index.html
          
          # Вставляем список файлов
          sed -i "s@__ALL_FILES__@$ALL_FILES@g" index.html

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Build: Update index.html with new assets and security"
          file_pattern: 'index.html'

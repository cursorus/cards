<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Галерея</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { 
            --bg: #050505; --accent: #fff; --pill: rgba(20,20,20,0.9); --gray: #555; 
            --nav-h: 65px; --radius: 35px; --text-op: 0.25;
        }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); color: #fff; font-family: -apple-system, sans-serif; overflow: hidden; }
        .flex-center { display: flex; align-items: center; justify-content: center; flex-direction: column; height: 100%; }
        .hidden { display: none !important; }

        /* ЛОАДЕР ПРИ ЗАГРУЗКЕ */
        #loading-overlay { 
            position: fixed; inset: 0; background: var(--bg); z-index: 3000; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            transition: opacity 0.5s ease;
        }
        .spinner { width: 40px; height: 40px; border: 3px solid #222; border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }

        /* НАВИГАЦИЯ */
        .nav-container { 
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; z-index: 1000; padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-pill { 
            display: flex; background: var(--pill); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); 
            height: var(--nav-h); border-radius: 40px; border: 1px solid rgba(255,255,255,0.1); 
            align-items: center; justify-content: space-around; padding: 0 10px;
        }
        .nav-item { 
            background: none; border: none; color: var(--gray); display: flex; flex-direction: column; 
            align-items: center; justify-content: center; gap: 2px; cursor: pointer; flex: 1; transition: 0.3s;
        }
        .nav-item.active { color: var(--accent); }
        .nav-item span { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .nav-item .material-symbols-rounded { font-size: 24px; }

        /* КОНТЕНТ */
        .tab-content { width: 100%; height: 100%; position: absolute; top: 0; left: 0; overflow: hidden; }
        .swiper { width: 85vw; max-width: 320px; height: 450px; overflow: visible; will-change: transform; }

        /* КАРТОЧКА */
        .swiper-slide { 
            border-radius: var(--radius); background: #000; overflow: hidden; 
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 15px 35px rgba(0,0,0,0.5);
            backface-visibility: hidden;
        }
        .card-layer-bg { position: absolute; inset: 0; display: flex; flex-direction: column; z-index: 1; border-radius: inherit; }
        .bg-half { flex: 1; width: 100%; position: relative; }
        .card-layer-overlay { position: absolute; inset: 0; background: url('cardbg.png') center/cover; z-index: 2; opacity: var(--text-op); }
        .is-light-bg { filter: invert(1) contrast(2); opacity: 0.4; }
        
        .main-img { 
            position: relative; z-index: 3; width: 100%; height: 100%; opacity: 0; 
            transition: opacity 0.4s ease; pointer-events: none; object-fit: contain; 
        }
        .main-img.fit-cover { object-fit: cover; }
        .main-img.loaded { opacity: 1; }

        /* ТЕГИ */
        .tag-cloud { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; padding: 20px; width: 100%; box-sizing: border-box; margin-top: -60px; }
        .tag-btn { background: #151515; color: #666; border: 1px solid #222; padding: 8px 14px; border-radius: 15px; font-size: 11px; font-weight: 700; transition: 0.2s; }
        .tag-btn.active { background: var(--accent); color: #000; border-color: var(--accent); }

        #auth-screen { z-index: 2500; position: fixed; inset: 0; background: var(--bg); }
        .dot { width: 12px; height: 12px; border: 2px solid #333; border-radius: 50%; transition: 0.2s; }
        .dot.filled { background: var(--accent); border-color: var(--accent); transform: scale(1.2); }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading-overlay" class="hidden">
        <div class="spinner"></div>
        <p style="margin-top: 15px; font-size: 12px; color: #555; font-weight: 600;">УТРАМБОВЫВАЕМ СТОПКУ...</p>
    </div>

    <div id="auth-screen" class="flex-center">
        <div class="pin-dots" style="display:flex; gap:15px; margin-bottom:40px;"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
        <div class="keypad" style="display:grid; grid-template-columns: repeat(3, 80px); gap:15px;">
            <div class="key" style="width:80px; height:80px; background:#111; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:24px;" onclick="press(1)">1</div>
            <div class="key" style="width:80px; height:80px; background:#111; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:24px;" onclick="press(2)">2</div>
            <div class="key" style="width:80px; height:80px; background:#111; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:24px;" onclick="press(3)">3</div>
            <div class="key" style="width:80px; height:80px; background:#111; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:24px;" onclick="press(4)">4</div>
            <div class="key" style="width:80px; height:80px; background:#111; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:24px;" onclick="press(5)">5</div>
            <div class="key" style="width:80px; height:80px; background:#111; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:24px;" onclick="press(6)">6</div>
            <div class="key" style="width:80px; height:80px; background:#111; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:24px;" onclick="press(7)">7</div>
            <div class="key" style="width:80px; height:80px; background:#111; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:24px;" onclick="press(8)">8</div>
            <div class="key" style="width:80px; height:80px; background:#111; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:24px;" onclick="press(9)">9</div>
            <div></div><div class="key" style="width:80px; height:80px; background:#111; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:24px;" onclick="press(0)">0</div>
            <div class="key" style="width:80px; height:80px; background:#111; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:24px;" onclick="press('C')">×</div>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        <div id="tab-main" class="tab-content flex-center">
            <div class="swiper" id="sw-main"><div class="swiper-wrapper" id="w-main"></div></div>
        </div>

        <div id="tab-tags" class="tab-content hidden flex-center">
            <div class="tag-cloud" id="t-cloud"></div>
            <div class="swiper" id="sw-tags"><div class="swiper-wrapper" id="w-tag"></div></div>
        </div>

        <div id="tab-upload" class="tab-content hidden flex-center">
            <div id="up-zone" class="flex-center" onclick="document.getElementById('fileIn').click()" style="width:280px; height:400px; border:2px dashed #222; border-radius:35px; color:#444">
                <span class="material-symbols-rounded" style="font-size:48px;">add_photo_alternate</span>
                <p>Нажми, чтобы добавить</p>
                <input type="file" id="fileIn" class="hidden" accept="image/*" multiple>
            </div>
        </div>

        <div class="nav-container">
            <div class="nav-pill">
                <button class="nav-item active" onclick="switchTab('main', this)"><span class="material-symbols-rounded"> dynamic_feed </span><span>Сток</span></button>
                <button class="nav-item" onclick="switchTab('tags', this)"><span class="material-symbols-rounded"> label </span><span>Теги</span></button>
                <button class="nav-item" onclick="switchTab('upload', this)"><span class="material-symbols-rounded"> upload_file </span><span>Стык</span></button>
                <div style="width: 1px; height: 30px; background: rgba(255,255,255,0.1);"></div>
                <button class="nav-item" onclick="downloadAllAsZip()"><span class="material-symbols-rounded"> folder_zip </span><span>ZIP</span></button>
                <button class="nav-item" onclick="handleAction()"><span class="material-symbols-rounded"> download </span><span>Save</span></button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script>
        const PIN_HASH = "4225466f46976e5877d0c8f7a77eafbf97a92841dedabae705816fa4c76e033f";
        const FILES = ["ru_arguments_1767868277325_12.enc","ru_arguments_1767868274034_9.enc","ru_arguments_1767868269647_5.enc","ru_arguments_1767868273062_8.enc","ru_arguments_1767868275164_10.enc","funny_1767871819421_0.enc","ru_arguments_1767868271940_7.enc","ru_arguments_1767868276175_11.enc","ru_arguments_1767868270752_6.enc","ru_arguments_1767868257796_0.enc","ru_arguments_1767868268258_4.enc","ru_arguments_1767868266905_3.enc","ru_arguments_1767868265015_2.enc","ru_arguments_1767868263202_1.enc"]; // Должен быть массив строк ["tag1_tag2.enc", ...]
        let userPin = "", activeTab = 'main', sm, st, fileCache = new Map();
        let dynamicTags = new Set();

        const swConf = { 
            effect: "cards", 
            grabCursor: true, 
            speed: 400,
            parallax: true,
            cardsEffect: { slideShadows: false, rotate: true, perSlideOffset: 10, perSlideRotate: 4 },
            observer: true,
            observeParents: true
        };

        function press(n) {
            if(n === 'C') userPin = ""; else if(userPin.length < 4) userPin += n;
            document.querySelectorAll('.dot').forEach((d, i) => d.className = i < userPin.length ? 'dot filled' : 'dot');
            if(userPin.length === 4) setTimeout(validatePin, 200);
        }

        async function validatePin() {
            if(CryptoJS.SHA256(userPin).toString() === PIN_HASH.replace(/['" ]/g, '')) {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('loading-overlay').classList.remove('hidden');
                await init();
            } else { userPin = ""; document.querySelectorAll('.dot').forEach(d => d.className = 'dot'); }
        }

        async function init() {
            // 1. Извлекаем теги из имен файлов (всё что до .enc, разделенное нижним подчеркиванием)
            FILES.forEach(f => {
                const tags = f.replace('.enc', '').split('_');
                tags.forEach(t => { if(t.length > 1) dynamicTags.add(t); });
            });

            // 2. Рендерим кнопки тегов
            const cloud = document.getElementById('t-cloud');
            dynamicTags.forEach(t => {
                const b = document.createElement('button');
                b.className = 'tag-btn'; b.innerText = t.toUpperCase();
                b.onclick = () => toggleTag(t, b);
                cloud.appendChild(b);
            });

            await renderMain();

            // Показываем приложение, убираем лоадер
            document.getElementById('app-screen').classList.remove('hidden');
            document.getElementById('loading-overlay').style.opacity = '0';
            setTimeout(() => document.getElementById('loading-overlay').classList.add('hidden'), 500);
        }

        async function renderMain() {
            const w = document.getElementById('w-main');
            for(let f of FILES) {
                if(!f.endsWith('.enc')) continue;
                try {
                    const r = await fetch(`images/${f}`);
                    const enc = await r.text();
                    const src = CryptoJS.AES.decrypt(enc, userPin).toString(CryptoJS.enc.Utf8);
                    const info = await getImageInfo(src);
                    const data = { src, ...info, tags: f.replace('.enc', '').split('_') };
                    fileCache.set(f, data);
                    w.appendChild(createSlide(data));
                } catch(e) { console.error("Ошибка файла:", f); }
            }
            sm = new Swiper("#sw-main", swConf);
        }

        function createSlide(data) {
            const slide = document.createElement('div'); slide.className = 'swiper-slide';
            if (!data.isVert) {
                const bg = document.createElement('div'); bg.className = 'card-layer-bg';
                [ {c: data.topColor, l: data.tLight}, {c: data.bottomColor, l: data.bLight} ].forEach(set => {
                    const h = document.createElement('div'); h.className = 'bg-half'; h.style.background = set.c;
                    const o = document.createElement('div'); o.className = 'card-layer-overlay' + (set.l ? ' is-light-bg' : '');
                    h.appendChild(o); bg.appendChild(h);
                });
                slide.appendChild(bg);
            }
            const img = document.createElement('img'); 
            img.className = `main-img ${data.isVert ? 'fit-cover' : 'fit-contain'}`;
            img.src = data.src; img.onload = () => img.classList.add('loaded');
            slide.appendChild(img);
            return slide;
        }

        function getImageInfo(src) {
            return new Promise(res => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                    canvas.width = img.width; canvas.height = img.height; ctx.drawImage(img, 0, 0);
                    const t = ctx.getImageData(img.width/2, 5, 1, 1).data;
                    const b = ctx.getImageData(img.width/2, img.height - 5, 1, 1).data;
                    const getB = (c) => (0.299*c[0] + 0.587*c[1] + 0.114*c[2]);
                    res({ isVert: img.height/img.width > 1.3, topColor: `rgb(${t[0]},${t[1]},${t[2]})`, bottomColor: `rgb(${b[0]},${b[1]},${b[2]})`, tLight: getB(t) > 180, bLight: getB(b) > 180 });
                };
                img.src = src;
            });
        }

        function switchTab(t, b) {
            activeTab = t;
            document.querySelectorAll('.tab-content').forEach(x => { if(x.id !== 'auth-screen') x.classList.add('hidden') });
            document.getElementById(`tab-${t}`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
            b.classList.add('active');
        }

        let selFilterTags = new Set();
        function toggleTag(t, el) {
            selFilterTags.has(t) ? selFilterTags.delete(t) : selFilterTags.add(t);
            el.classList.toggle('active');
            const w = document.getElementById('w-tag'); w.innerHTML = '';
            const active = Array.from(selFilterTags);
            if(active.length) {
                Array.from(fileCache.values()).filter(it => active.every(tag => it.tags.includes(tag))).forEach(d => w.appendChild(createSlide(d)));
                if(st) st.destroy(); st = new Swiper("#sw-tags", swConf);
            }
        }

        async function downloadAllAsZip() {
            const zip = new JSZip();
            let count = 0;
            fileCache.forEach((data) => {
                const base64Data = data.src.split(',')[1];
                zip.file(`image_${count}.png`, base64Data, {base64: true});
                count++;
            });
            const content = await zip.generateAsync({type:"blob"});
            const a = document.createElement('a'); a.href = URL.createObjectURL(content); a.download = "gallery.zip"; a.click();
        }

        function handleAction() {
            const sw = (activeTab === 'main') ? sm : st;
            if(!sw || !sw.slides[sw.activeIndex]) return;
            const img = sw.slides[sw.activeIndex].querySelector('.main-img');
            const a = document.createElement('a'); a.href = img.src; a.download = "save_image.png"; a.click();
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Карточки Финал</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { 
            --bg: #050505; --accent: #fff; --pill: #1a1a1a; --gray: #666; 
            --nav-h: 60px; --radius: 30px; 
        }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); color: #fff; font-family: -apple-system, sans-serif; overflow: hidden; }
        .flex-center { display: flex; align-items: center; justify-content: center; flex-direction: column; height: 100%; }
        .hidden { display: none !important; }

        /* ЛОАДЕР */
        #loading-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .spinner { width: 50px; height: 50px; border: 4px solid #333; border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }

        /* НАВИГАЦИЯ */
        .nav-container { position: fixed; bottom: 30px; left: 0; right: 0; display: flex; justify-content: center; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); pointer-events: none; }
        .nav-pill { pointer-events: auto; display: flex; background: var(--pill); border: 1px solid #333; height: var(--nav-h); border-radius: 40px; padding: 0 15px; align-items: center; gap: 5px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .nav-item { background: transparent; border: none; color: var(--gray); display: flex; flex-direction: column; align-items: center; justify-content: center; width: 60px; height: 100%; cursor: pointer; transition: 0.2s; }
        .nav-item.active { color: var(--accent); }
        .nav-item span { font-size: 26px; }
        .nav-item p { font-size: 9px; margin: 0; font-weight: 700; text-transform: uppercase; margin-top: 2px; }

        /* СВАЙПЕР */
        .tab-content { position: absolute; inset: 0; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .tab-content.active-tab { opacity: 1; pointer-events: auto; }
        
        .swiper { width: 320px; height: 480px; overflow: visible; }
        .swiper-slide { 
            border-radius: var(--radius); background: #111; overflow: hidden; 
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.9);
            position: relative; /* Для позиционирования слоев */
        }
        
        /* КАРТИНКА И ФОН (ВЕРНУЛ СТАРУЮ СИСТЕМУ) */
        .card-layer-bg { position: absolute; inset: 0; display: flex; flex-direction: column; z-index: 1; pointer-events: none; }
        .bg-half { flex: 1; width: 100%; position: relative; transition: background 0.3s; }
        
        /* Тот самый оверлей, который был нужен */
        .card-layer-overlay { 
            position: absolute; inset: 0; 
            background: url('cardbg.png') center/cover; 
            opacity: 0.2; 
            mix-blend-mode: overlay; 
        }

        .main-img { position: relative; z-index: 5; width: 100%; height: 100%; object-fit: contain; opacity: 0; transition: opacity 0.3s; }
        .main-img.fit-cover { object-fit: cover; }
        .main-img.visible { opacity: 1; }

        /* ТЕГИ */
        .tag-wrap { position: absolute; top: 60px; left: 0; right: 0; display: flex; justify-content: center; flex-wrap: wrap; gap: 8px; padding: 0 20px; z-index: 100; pointer-events: none; }
        .tag-btn { pointer-events: auto; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); color: #888; border: 1px solid #333; padding: 8px 16px; border-radius: 20px; font-size: 11px; font-weight: 800; text-transform: uppercase; }
        .tag-btn.active { background: var(--accent); color: #000; border-color: var(--accent); }

        /* АВТОРИЗАЦИЯ */
        #auth-screen { z-index: 5000; position: fixed; inset: 0; background: #000; }
        .key { width: 70px; height: 70px; border-radius: 50%; background: #151515; display: flex; align-items: center; justify-content: center; font-size: 24px; active: scale(0.9); }
        .dots { display: flex; gap: 15px; margin-bottom: 40px; }
        .dot { width: 12px; height: 12px; border: 2px solid #333; border-radius: 50%; }
        .dot.filled { background: #fff; border-color: #fff; }
        
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading-overlay" class="hidden">
        <div class="spinner"></div>
        <div id="load-text" style="margin-top:20px; font-size:12px; color:#666; font-family:monospace;">INIT SYSTEM...</div>
    </div>

    <div id="auth-screen" class="flex-center">
        <div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
        <div style="display:grid; grid-template-columns:repeat(3, 80px); gap:20px;">
            <div class="key" onclick="kp(1)">1</div><div class="key" onclick="kp(2)">2</div><div class="key" onclick="kp(3)">3</div>
            <div class="key" onclick="kp(4)">4</div><div class="key" onclick="kp(5)">5</div><div class="key" onclick="kp(6)">6</div>
            <div class="key" onclick="kp(7)">7</div><div class="key" onclick="kp(8)">8</div><div class="key" onclick="kp(9)">9</div>
            <div></div><div class="key" onclick="kp(0)">0</div><div class="key" onclick="kp('C')">×</div>
        </div>
    </div>

    <div id="app" class="hidden">
        
        <div id="view-main" class="tab-content active-tab flex-center">
            <div class="swiper" id="sw-main"><div class="swiper-wrapper" id="wr-main"></div></div>
        </div>

        <div id="view-tags" class="tab-content flex-center">
            <div class="tag-wrap" id="tag-cloud"></div>
            <div class="swiper" id="sw-tags"><div class="swiper-wrapper" id="wr-tags"></div></div>
        </div>

        <div id="view-up" class="tab-content flex-center">
             <div onclick="document.getElementById('fIn').click()" style="width:260px; height:380px; border:2px dashed #333; border-radius:30px; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#555; cursor: pointer;">
                <span class="material-symbols-rounded" style="font-size:40px">add</span>
                <span style="font-size:12px; margin-top:10px; font-weight:700;">ДОБАВИТЬ ФАЙЛЫ</span>
             </div>
             <input type="file" id="fIn" hidden multiple accept="image/*,.enc">
        </div>

        <div class="nav-container">
            <div class="nav-pill">
                <button class="nav-item active" onclick="tab('main', this)"><span class="material-symbols-rounded">layers</span><p>Сток</p></button>
                <button class="nav-item" onclick="tab('tags', this)"><span class="material-symbols-rounded">tag</span><p>Теги</p></button>
                <button class="nav-item" onclick="tab('up', this)"><span class="material-symbols-rounded">upload</span><p>Стык</p></button>
                <div style="width:1px; height:25px; background:#333; margin:0 5px;"></div>
                <button class="nav-item" onclick="saveActive()"><span class="material-symbols-rounded">download</span><p>Сейв</p></button>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script>
        // --- НАСТРОЙКИ ---
        const PIN_HASH = "03ac674216f3e15c761ee1a5e255f067953623c8b388b4459e13f978d7c846f4"; // Пароль: 1234
        const FILES = typeof ["ru_arguments_1767868277325_12.enc","ru_arguments_1767868274034_9.enc","ru_arguments_1767868269647_5.enc","ru_arguments_1767868273062_8.enc","ru_arguments_1767868275164_10.enc","funny_1767871819421_0.enc","ru_arguments_1767868271940_7.enc","ru_arguments_1767868276175_11.enc","ru_arguments_1767868270752_6.enc","ru_arguments_1767868257796_0.enc","ru_arguments_1767868268258_4.enc","ru_arguments_1767868266905_3.enc","ru_arguments_1767868265015_2.enc","ru_arguments_1767868263202_1.enc"] !== 'undefined' ? ["ru_arguments_1767868277325_12.enc","ru_arguments_1767868274034_9.enc","ru_arguments_1767868269647_5.enc","ru_arguments_1767868273062_8.enc","ru_arguments_1767868275164_10.enc","funny_1767871819421_0.enc","ru_arguments_1767868271940_7.enc","ru_arguments_1767868276175_11.enc","ru_arguments_1767868270752_6.enc","ru_arguments_1767868257796_0.enc","ru_arguments_1767868268258_4.enc","ru_arguments_1767868266905_3.enc","ru_arguments_1767868265015_2.enc","ru_arguments_1767868263202_1.enc"] : []; 
        const ALLOWED_TAGS = ["funny", "arguments", "narkoman", "parents", "art", "personal", "screenshot"]; 

        let pin = "", cache = [], swMain, swTags;
        
        // --- PIN LOGIC ---
        window.kp = function(n) {
            if(n==='C') pin = ""; else if(pin.length < 4) pin += n;
            document.querySelectorAll('.dot').forEach((d,i) => d.className = i<pin.length?'dot filled':'dot');
            if(pin.length === 4) checkPin();
        }
        
        async function checkPin() {
            const inputHash = CryptoJS.SHA256(pin).toString().toLowerCase();
            const targetHash = PIN_HASH.toLowerCase();

            if(inputHash === targetHash) {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('loading-overlay').classList.remove('hidden');
                setTimeout(startApp, 300);
            } else {
                pin=""; document.querySelectorAll('.dot').forEach(d=>d.className='dot');
                if(navigator.vibrate) navigator.vibrate(200);
            }
        }

        // --- CORE LOGIC ---
        async function startApp() {
            // 1. Инициализация обработки загрузки файлов (ЭТОГО НЕ БЫЛО В ПРОШЛЫЙ РАЗ)
            const fileInput = document.getElementById('fIn');
            fileInput.addEventListener('change', handleFileUpload);

            const txt = document.getElementById('load-text');
            const wr = document.getElementById('wr-main');
            let loadedCount = 0;

            const encFiles = FILES.filter(f => f.endsWith('.enc'));
            
            // Если файлов нет, не крашимся, а просто запускаем интерфейс
            if(encFiles.length === 0) {
                txt.innerText = "NO SERVER FILES";
                setTimeout(finishLoad, 500);
            } else {
                for (let f of encFiles) {
                    try {
                        txt.innerText = `DECRYPTING ${loadedCount + 1}/${encFiles.length}`;
                        const res = await fetch(`images/${f}`);
                        if(!res.ok) throw new Error('404');
                        const blob = await res.text();
                        
                        const src = CryptoJS.AES.decrypt(blob, pin).toString(CryptoJS.enc.Utf8);
                        if(!src.startsWith('data:image')) throw new Error('Bad Decrypt');

                        const meta = await analyzeImage(src);
                        const foundTags = ALLOWED_TAGS.filter(tag => f.toLowerCase().includes(tag));
                        const item = { id: f, src, ...meta, tags: foundTags };
                        cache.push(item);
                        wr.appendChild(buildSlide(item));
                        loadedCount++;
                    } catch (e) {
                        console.warn(`Skip ${f}:`, e);
                    }
                }
                setTimeout(finishLoad, 100);
            }
        }

        function finishLoad() {
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('loading-overlay').classList.add('hidden');
            renderTagButtons();
            // Задержка чтобы DOM обновился
            setTimeout(() => { swMain = initSwiper('#sw-main'); }, 100);
        }

        // --- НОВАЯ ФУНКЦИЯ ЗАГРУЗКИ ---
        async function handleFileUpload(e) {
            const files = Array.from(e.target.files);
            if(!files.length) return;

            const wr = document.getElementById('wr-main');
            
            // Переключаемся на главную вкладку, чтобы видеть результат
            tab('main', document.querySelector('.nav-item:first-child'));

            for (let file of files) {
                try {
                    // Читаем файл
                    const src = await readFileAsDataURL(file);
                    
                    // Если это .enc файл, пробуем расшифровать текущим пинкодом
                    let finalSrc = src;
                    if(file.name.endsWith('.enc')) {
                        // Для .enc нужно читать как текст, но readFileAsDataURL вернет base64. 
                        // Упростим: допустим пользователь грузит обычные фото или расшифрованные.
                        // Если вы грузите именно ЗАШИФРОВАННЫЙ ТЕКСТ через input, нужно сложнее.
                        // Но обычно через Upload кидают просто фотки.
                    }

                    const meta = await analyzeImage(finalSrc);
                    // Ищем теги в имени загруженного файла
                    const foundTags = ALLOWED_TAGS.filter(tag => file.name.toLowerCase().includes(tag));
                    
                    const item = { id: file.name, src: finalSrc, ...meta, tags: foundTags };
                    cache.push(item);
                    
                    // Добавляем слайд
                    const slide = buildSlide(item);
                    wr.appendChild(slide);

                } catch (err) {
                    console.error("File load error", err);
                }
            }

            // Обновляем свайпер и прыгаем в конец
            if(swMain) {
                swMain.update();
                swMain.slideTo(swMain.slides.length - 1);
            }
            renderTagButtons();
        }

        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function analyzeImage(src) {
            return new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.onload = () => {
                    let isVert = img.height > img.width * 1.2;
                    let tc = '#111', bc = '#111';
                    try {
                        const cvs = document.createElement('canvas');
                        cvs.width = 1; cvs.height = 1;
                        const ctx = cvs.getContext('2d');
                        ctx.drawImage(img, img.width/2, 0, 1, 1, 0, 0, 1, 1);
                        const t = ctx.getImageData(0,0,1,1).data;
                        tc = `rgb(${t[0]},${t[1]},${t[2]})`;
                        ctx.drawImage(img, img.width/2, img.height-1, 1, 1, 0, 0, 1, 1);
                        const b = ctx.getImageData(0,0,1,1).data;
                        bc = `rgb(${b[0]},${b[1]},${b[2]})`;
                    } catch(e) { }
                    resolve({ isVert, tc, bc });
                };
                img.onerror = () => resolve({ isVert: true, tc:'#000', bc:'#000' });
                img.src = src;
            });
        }

        // --- ВЕРНУЛ СТАРУЮ СИСТЕМУ СЛОЕВ ---
        function buildSlide(data) {
            const div = document.createElement('div');
            div.className = 'swiper-slide';
            
            let bgHTML = '';
            // Если картинка горизонтальная, делаем красивый фон
            if(!data.isVert) {
                bgHTML = `<div class="card-layer-bg">
                    <div class="bg-half" style="background:${data.tc}">
                        <div class="card-layer-overlay"></div>
                    </div>
                    <div class="bg-half" style="background:${data.bc}">
                        <div class="card-layer-overlay"></div>
                    </div>
                </div>`;
            }
            
            div.innerHTML = `${bgHTML}<img src="${data.src}" class="main-img ${data.isVert?'fit-cover':'fit-contain'} visible">`;
            return div;
        }

        function initSwiper(sel) {
            return new Swiper(sel, {
                effect: "cards",
                grabCursor: true,
                cardsEffect: { slideShadows: false, perSlideOffset: 8, perSlideRotate: 2 },
                speed: 400,
                observer: true,
                observeParents: true
            });
        }

        // --- TAG SYSTEM ---
        let activeTags = new Set();
        function renderTagButtons() {
            const c = document.getElementById('tag-cloud');
            c.innerHTML = '';
            const usedTags = [...new Set(cache.flatMap(x => x.tags))];
            usedTags.forEach(t => {
                const b = document.createElement('button');
                b.className = 'tag-btn';
                b.innerText = t;
                if(activeTags.has(t)) b.classList.add('active'); // Сохраняем состояние
                b.onclick = () => filterByTag(t, b);
                c.appendChild(b);
            });
        }

        function filterByTag(tag, btn) {
            if(activeTags.has(tag)) activeTags.delete(tag); else activeTags.add(tag);
            btn.classList.toggle('active');
            
            const wr = document.getElementById('wr-tags');
            wr.innerHTML = '';
            
            if(activeTags.size > 0) {
                const filtered = cache.filter(item => 
                    [...activeTags].every(reqTag => item.tags.includes(reqTag))
                );
                filtered.forEach(item => wr.appendChild(buildSlide(item)));
            }
            
            if(swTags) swTags.destroy();
            swTags = initSwiper('#sw-tags');
        }

        // --- NAVIGATION ---
        function tab(name, btn) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active-tab'));
            document.getElementById('view-'+name).classList.add('active-tab');
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
        }

        function saveActive() {
            const isMain = document.getElementById('view-main').classList.contains('active-tab');
            const sw = isMain ? swMain : swTags;
            if(!sw || !sw.slides.length) return;
            const img = sw.slides[sw.activeIndex].querySelector('img');
            const a = document.createElement('a');
            a.href = img.src;
            a.download = `saved_${Date.now()}.png`;
            a.click();
        }
    </script>
</body>
</html>

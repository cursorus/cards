<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Safe Storage</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <style>
        :root { --bg: #000; --accent: #fff; --gray: #555; --bounce: cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); color: #fff; font-family: -apple-system, sans-serif; overflow: hidden; touch-action: manipulation; }
        .flex { display: flex; align-items: center; justify-content: center; flex-direction: column; height: 100%; }
        .hidden { display: none !important; }

        /* ПИН-ЭКРАН */
        #auth-screen { z-index: 9999; position: fixed; inset: 0; background: #000; }
        .dots-row { display: flex; gap: 20px; margin-bottom: 50px; }
        .dot { width: 14px; height: 14px; border: 2px solid #333; border-radius: 50%; transition: 0.2s; }
        .dot.filled { background: #fff; border-color: #fff; transform: scale(1.3); box-shadow: 0 0 10px #fff; }
        
        .keypad { display: grid; grid-template-columns: repeat(3, 80px); gap: 20px; }
        .key { 
            width: 80px; height: 80px; background: #111; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 28px; cursor: pointer; user-select: none; -webkit-tap-highlight-color: transparent;
        }
        .key:active { transform: scale(0.85); background: #333; transition: 0.1s; }

        /* ИНТЕРФЕЙС */
        .bottom-ui { position: fixed; bottom: 30px; width: 100%; display: flex; justify-content: center; align-items: center; gap: 15px; z-index: 100; }
        .nav-pill { display: flex; background: rgba(255,255,255,0.05); backdrop-filter: blur(20px); padding: 8px; border-radius: 40px; border: 1px solid rgba(255,255,255,0.1); }
        .nav-btn { background: none; border: none; color: var(--gray); display: flex; flex-direction: column; align-items: center; gap: 2px; padding: 10px 18px; border-radius: 30px; transition: 0.3s; }
        .nav-btn.active { color: #fff; background: rgba(255,255,255,0.1); }
        .nav-btn span { font-size: 9px; font-weight: 900; text-transform: uppercase; }

        .action-btn { width: 60px; height: 60px; background: #fff; color: #000; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s var(--bounce); }
        .action-btn:active { transform: scale(0.8); }

        /* ЗАГРУЗКА */
        .up-box { position: relative; width: 200px; height: 260px; display: flex; align-items: center; justify-content: center; }
        .p-img { width: 100%; height: 100%; object-fit: cover; border-radius: 30px; border: 2px solid #222; position: absolute; z-index: 10; transition: 0.8s cubic-bezier(0.5, 0, 0.2, 1); }
        .fly { transform: translateY(-800px) scale(0.1); opacity: 0; }
        .loader-wrap { position: absolute; z-index: 1; }
        .ring { width: 45px; height: 45px; border: 4px solid #111; border-top-color: #fff; border-radius: 50%; animation: rot 0.8s linear infinite; }
        @keyframes rot { to { transform: rotate(360deg); } }
        .check { width: 50px; height: 50px; background: #fff; color: #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; transform: scale(0); transition: 0.5s var(--bounce); }

        /* ТЕГИ */
        .tags-list { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; padding: 20px; max-width: 350px; }
        .t-btn { background: #111; color: #555; border: 1px solid #222; padding: 10px 15px; border-radius: 20px; font-size: 11px; font-weight: 800; cursor: pointer; transition: 0.2s; }
        .t-btn.active { background: #fff; color: #000; border-color: #fff; }
        .t-btn.disabled { opacity: 0.1; pointer-events: none; }

        /* СЛАЙДЕР */
        .swiper { width: 310px; height: 450px; }
        .swiper-slide { border-radius: 35px; background: #080808; overflow: hidden; border: 1px solid #111; }
        .swiper-slide img { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>

    <div id="auth-screen" class="flex">
        <div class="dots-row">
            <div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div>
        </div>
        <div class="keypad">
            <div class="key" onclick="pressPin('1')">1</div><div class="key" onclick="pressPin('2')">2</div><div class="key" onclick="pressPin('3')">3</div>
            <div class="key" onclick="pressPin('4')">4</div><div class="key" onclick="pressPin('5')">5</div><div class="key" onclick="pressPin('6')">6</div>
            <div class="key" onclick="pressPin('7')">7</div><div class="key" onclick="pressPin('8')">8</div><div class="key" onclick="pressPin('9')">9</div>
            <div></div><div class="key" onclick="pressPin('0')">0</div><div class="key" onclick="pressPin('C')">×</div>
        </div>
    </div>

    <div id="app" class="flex hidden">
        <div id="tab-main" class="tab-content flex">
            <div class="swiper" id="sw-main"><div class="swiper-wrapper" id="w-main"></div></div>
        </div>

        <div id="tab-tags" class="tab-content hidden flex">
            <div class="tags-list" id="filter-tags-box"></div>
            <div class="swiper" id="sw-tags" style="margin-top:20px"><div class="swiper-wrapper" id="w-tags"></div></div>
        </div>

        <div id="tab-upload" class="tab-content hidden flex">
            <div id="up-empty" onclick="document.getElementById('fileInput').click()" class="flex" style="color:#222; cursor:pointer">
                <span class="material-symbols-rounded" style="font-size: 70px;">add_a_photo</span>
                <p style="font-size: 10px; font-weight: 900;">ВЫБРАТЬ ОБЪЕКТ</p>
                <input type="file" id="fileInput" class="hidden" accept="image/*" onchange="previewFile(this)">
            </div>
            
            <div id="up-ready" class="hidden flex">
                <div class="up-box">
                    <img id="p-img" class="p-img">
                    <div class="loader-wrap">
                        <div id="ring" class="ring hidden"></div>
                        <div id="done" class="check"><span class="material-symbols-rounded">done_all</span></div>
                    </div>
                </div>
                <div class="tags-list" id="upload-tags-box" style="margin-top:20px"></div>
            </div>
        </div>

        <div class="bottom-ui">
            <div class="nav-pill">
                <button class="nav-btn active" onclick="switchTab('main', this)"><span class="material-symbols-rounded">grid_view</span><span>Склад</span></button>
                <button class="nav-btn" onclick="switchTab('tags', this)"><span class="material-symbols-rounded">style</span><span>Теги</span></button>
                <button class="nav-btn" onclick="switchTab('upload', this)"><span class="material-symbols-rounded">cloud_upload</span><span>Загрузка</span></button>
            </div>
            <button class="action-btn" onclick="doAction()"><span class="material-symbols-rounded" id="act-icon">download</span></button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script>
        // ДАННЫЕ ОТ GITHUB
        const PIN_HASH = "__PIN_HASH__";
        const TYPES = __TYPES_JSON__;
        const FILES = __ALL_FILES__;
        const REPO = "cursorus/cards"; // <--- ЗАМЕНИТЬ!

        let currentPin = "";
        let activeTab = 'main';
        let mainSwiper, tagSwiper;
        let selectedFilterTags = [];
        let selectedUploadTags = [];
        let rawFileData = null;

        // --- ЛОГИКА ПИН-КОДА (МАКСИМАЛЬНО ПРОСТАЯ) ---
        function pressPin(v) {
            if (v === 'C') {
                currentPin = "";
            } else if (currentPin.length < 4) {
                currentPin += v;
            }

            // Визуализация точек
            const dots = document.querySelectorAll('.dot');
            dots.forEach((d, i) => {
                if (i < currentPin.length) d.classList.add('filled');
                else d.classList.remove('filled');
            });

            if (currentPin.length === 4) {
                setTimeout(() => {
                    const inputHash = CryptoJS.SHA256(currentPin).toString();
                    if (inputHash === PIN_HASH) {
                        document.getElementById('auth-screen').classList.add('hidden');
                        document.getElementById('app').classList.remove('hidden');
                        initApp();
                    } else {
                        alert("ОШИБКА ПИН-КОДА");
                        currentPin = "";
                        dots.forEach(d => d.classList.remove('filled'));
                    }
                }, 100);
            }
        }

        // --- ИНИЦИАЛИЗАЦИЯ ---
        function initApp() {
            const container = document.getElementById('w-main');
            FILES.forEach(f => {
                if (f.endsWith('.enc')) container.appendChild(createSlide(f));
            });
            mainSwiper = new Swiper("#sw-main", { effect: "cards", grabCursor: true });
            
            // Отрисовка тегов
            const allTags = ["ru", "en", ...Object.keys(TYPES)];
            const fBox = document.getElementById('filter-tags-box');
            const uBox = document.getElementById('upload-tags-box');

            allTags.forEach(t => {
                fBox.appendChild(makeTagElement(t, selectedFilterTags, updateFilter));
                uBox.appendChild(makeTagElement(t, selectedUploadTags, () => {}));
            });
        }

        function makeTagElement(t, array, callback) {
            const b = document.createElement('button');
            b.className = 't-btn';
            b.innerText = t.toUpperCase();
            b.onclick = () => {
                if (array.includes(t)) {
                    array.splice(array.indexOf(t), 1);
                } else {
                    if (t === 'funny' && array.includes('arguments')) return;
                    if (t === 'arguments' && array.includes('funny')) return;
                    array.push(t);
                }
                updateTagVisuals();
                callback();
            };
            b.dataset.tag = t;
            return b;
        }

        function updateTagVisuals() {
            document.querySelectorAll('.t-btn').forEach(b => {
                const t = b.dataset.tag;
                const isFilter = b.parentElement.id === 'filter-tags-box';
                const arr = isFilter ? selectedFilterTags : selectedUploadTags;
                
                b.classList.toggle('active', arr.includes(t));
                
                if ((t === 'funny' && arr.includes('arguments')) || (t === 'arguments' && arr.includes('funny'))) {
                    b.classList.add('disabled');
                } else {
                    b.classList.remove('disabled');
                }
            });
        }

        function createSlide(filename) {
            const slide = document.createElement('div');
            slide.className = 'swiper-slide';
            const img = document.createElement('img');
            slide.appendChild(img);

            fetch(`images/${filename}`).then(r => r.text()).then(enc => {
                try {
                    const dec = CryptoJS.AES.decrypt(enc, currentPin).toString(CryptoJS.enc.Utf8);
                    img.src = dec;
                } catch(e) { slide.innerHTML = '<center style="margin-top:200px">ERR</center>'; }
            });
            return slide;
        }

        function updateFilter() {
            const w = document.getElementById('w-tags');
            w.innerHTML = '';
            const filtered = FILES.filter(f => selectedFilterTags.every(t => f.includes(t)));
            filtered.forEach(f => w.appendChild(createSlide(f)));
            if (tagSwiper) tagSwiper.destroy();
            tagSwiper = new Swiper("#sw-tags", { effect: "cards" });
        }

        function switchTab(t, btn) {
            activeTab = t;
            document.querySelectorAll('.tab-content').forEach(x => x.classList.add('hidden'));
            document.getElementById(`tab-${t}`).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(x => x.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('act-icon').innerText = t === 'upload' ? 'publish' : 'download';
        }

        function previewFile(input) {
            const reader = new FileReader();
            reader.onload = (e) => {
                rawFileData = e.target.result;
                document.getElementById('p-img').src = rawFileData;
                document.getElementById('up-ready').classList.remove('hidden');
                document.getElementById('up-empty').classList.add('hidden');
            };
            reader.readAsDataURL(input.files[0]);
        }

        async function doAction() {
            if (activeTab === 'upload') {
                if (!rawFileData || selectedUploadTags.length === 0) return alert("ВЫБЕРИ ТЕГИ");
                const token = prompt("GitHub Token:");
                if (!token) return;

                document.getElementById('p-img').classList.add('fly');
                document.getElementById('ring').classList.remove('hidden');

                try {
                    const encrypted = CryptoJS.AES.encrypt(rawFileData, currentPin).toString();
                    const name = `${selectedUploadTags.join('.')}.${Date.now()}.enc`;
                    
                    const res = await fetch(`https://api.github.com/repos/${REPO}/contents/images/${name}`, {
                        method: 'PUT',
                        headers: { 'Authorization': `token ${token}` },
                        body: JSON.stringify({ 
                            message: "vault update", 
                            content: btoa(unescape(encodeURIComponent(encrypted))) 
                        })
                    });

                    if (res.ok) {
                        document.getElementById('ring').classList.add('hidden');
                        document.getElementById('done').style.transform = 'scale(1)';
                        setTimeout(() => location.reload(), 1500);
                    } else { alert("ОШИБКА API"); }
                } catch(e) { alert("ОШИБКА"); }
            } else {
                const s = activeTab === 'main' ? mainSwiper : tagSwiper;
                if (!s || !s.slides.length) return;
                const a = document.createElement('a');
                a.href = s.slides[s.activeIndex].querySelector('img').src;
                a.download = "secure_photo.png";
                a.click();
            }
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Cards Fix</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root { 
            --bg: #050505; --accent: #fff; --pill: #1a1a1a; --gray: #666; 
            --nav-h: 60px; --radius: 30px; 
        }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); color: #fff; font-family: -apple-system, sans-serif; overflow: hidden; }
        .flex-center { display: flex; align-items: center; justify-content: center; flex-direction: column; height: 100%; }
        .hidden { display: none !important; }

        #loading-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 3px solid #333; border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }

        /* Навигация */
        .nav-container { position: fixed; bottom: 30px; left: 0; right: 0; display: flex; justify-content: center; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); pointer-events: none; }
        .nav-pill { pointer-events: auto; display: flex; background: var(--pill); border: 1px solid #333; height: var(--nav-h); border-radius: 40px; padding: 0 15px; align-items: center; gap: 5px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .nav-item { background: transparent; border: none; color: var(--gray); display: flex; flex-direction: column; align-items: center; justify-content: center; width: 60px; height: 100%; cursor: pointer; transition: 0.2s; }
        .nav-item.active { color: var(--accent); }
        .nav-item span { font-size: 24px; }
        .nav-item p { font-size: 8px; margin: 2px 0 0; font-weight: 700; text-transform: uppercase; }

        /* Слайдер */
        .swiper { width: 85vw; height: 65vh; max-width: 340px; max-height: 500px; perspective: 1200px; overflow: visible; }
        .swiper-slide { border-radius: var(--radius); background: #111; overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center; box-shadow: 0 20px 40px rgba(0,0,0,0.6); }
        
        .card-layer-bg { position: absolute; inset: 0; display: flex; flex-direction: column; z-index: 1; }
        .bg-half { flex: 1; width: 100%; position: relative; }
        .card-layer-overlay { position: absolute; inset: 0; background: url('cardbg.png') center/cover; opacity: 0.15; mix-blend-mode: overlay; z-index: 2; pointer-events: none; }
        
        .main-img { position: relative; z-index: 5; width: 100%; height: 100%; object-fit: contain; }
        .fit-cover { object-fit: cover; }

        .tab-content { position: absolute; inset: 0; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 10; }
        .tab-content.active-tab { opacity: 1; pointer-events: auto; }

        /* Авторизация */
        #auth-screen { z-index: 5000; position: fixed; inset: 0; background: #000; }
        .dots { display: flex; gap: 15px; margin-bottom: 40px; }
        .dot { width: 12px; height: 12px; border: 2px solid #333; border-radius: 50%; transition: 0.2s; }
        .dot.filled { background: #fff; border-color: #fff; transform: scale(1.2); }
        .key-grid { display: grid; grid-template-columns: repeat(3, 80px); gap: 20px; }
        .key { width: 75px; height: 75px; border-radius: 50%; background: #111; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; -webkit-tap-highlight-color: transparent; }
        .key:active { background: #222; transform: scale(0.95); }

        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading-overlay" class="hidden"><div class="spinner"></div></div>

    <div id="auth-screen" class="flex-center">
        <div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
        <div class="key-grid">
            <div class="key" onclick="kp(1)">1</div><div class="key" onclick="kp(2)">2</div><div class="key" onclick="kp(3)">3</div>
            <div class="key" onclick="kp(4)">4</div><div class="key" onclick="kp(5)">5</div><div class="key" onclick="kp(6)">6</div>
            <div class="key" onclick="kp(7)">7</div><div class="key" onclick="kp(8)">8</div><div class="key" onclick="kp(9)">9</div>
            <div></div><div class="key" onclick="kp(0)">0</div><div class="key" onclick="kp('C')">×</div>
        </div>
    </div>

    <div id="app" class="hidden">
        <div id="view-main" class="tab-content active-tab flex-center">
            <div class="swiper" id="sw-main"><div class="swiper-wrapper" id="wr-main"></div></div>
        </div>

        <div id="view-tags" class="tab-content flex-center">
            <div id="tag-cloud" style="position:absolute; top:40px; display:flex; gap:10px; flex-wrap:wrap; justify-content:center; padding:20px;"></div>
            <div class="swiper" id="sw-tags"><div class="swiper-wrapper" id="wr-tags"></div></div>
        </div>

        <div id="view-up" class="tab-content flex-center">
             <div onclick="document.getElementById('fIn').click()" style="width:280px; height:400px; border:2px dashed #333; border-radius:30px; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#666; cursor:pointer;">
                <span class="material-symbols-rounded" style="font-size:48px">add_photo_alternate</span>
                <p style="font-size:12px; margin-top:15px; font-weight:700;">КЛИКНИ ДЛЯ ЗАГРУЗКИ</p>
             </div>
             <input type="file" id="fIn" hidden multiple accept="image/*">
        </div>

        <div class="nav-container">
            <div class="nav-pill">
                <button class="nav-item active" onclick="tab('main', this)"><span class="material-symbols-rounded">style</span><p>Сток</p></button>
                <button class="nav-item" onclick="tab('tags', this)"><span class="material-symbols-rounded">sell</span><p>Теги</p></button>
                <button class="nav-item" onclick="tab('up', this)"><span class="material-symbols-rounded">cloud_upload</span><p>Стык</p></button>
                <div style="width:1px; height:20px; background:#333; margin:0 10px;"></div>
                <button class="nav-item" onclick="saveActive()"><span class="material-symbols-rounded">download</span><p>Сейв</p></button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script>
        const PIN_HASH = "03ac674216f3e15c761ee1a5e255f067953623c8b388b4459e13f978d7c846f4"; 
        let pin = "", cache = [], swMain, swTags;

        function kp(n) {
            if(n==='C') pin = ""; else if(pin.length < 4) pin += n;
            document.querySelectorAll('.dot').forEach((d,i) => d.className = i < pin.length ? 'dot filled' : 'dot');
            if(pin.length === 4) {
                if(CryptoJS.SHA256(pin).toString() === PIN_HASH) {
                    document.getElementById('auth-screen').classList.add('hidden');
                    document.getElementById('app').classList.remove('hidden');
                    initAll();
                } else {
                    pin = "";
                    document.querySelectorAll('.dot').forEach(d => d.className = 'dot');
                }
            }
        }

        function initAll() {
            document.getElementById('fIn').addEventListener('change', handleUpload);
            swMain = new Swiper('#sw-main', { effect: "cards", grabCursor: true });
        }

        async function handleUpload(e) {
            const files = Array.from(e.target.files);
            if(!files.length) return;
            
            document.getElementById('loading-overlay').classList.remove('hidden');
            
            for(let file of files) {
                await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = async (ev) => {
                        const src = ev.target.result;
                        const meta = await analyzeImg(src);
                        const item = { id: file.name, src, ...meta, tags: [] };
                        cache.push(item);
                        const slide = buildSlide(item);
                        document.getElementById('wr-main').appendChild(slide);
                        resolve();
                    };
                    reader.readAsDataURL(file);
                });
            }
            
            swMain.update();
            tab('main', document.querySelector('.nav-item'));
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        function analyzeImg(src) {
            return new Promise(res => {
                const img = new Image();
                img.onload = () => {
                    const cvs = document.createElement('canvas');
                    const ctx = cvs.getContext('2d');
                    cvs.width = 1; cvs.height = 1;
                    ctx.drawImage(img, 0, 0, 1, 1);
                    const [r,g,b] = ctx.getImageData(0,0,1,1).data;
                    res({ isVert: img.height > img.width * 1.1, c: `rgb(${r},${g},${b})` });
                };
                img.src = src;
            });
        }

        function buildSlide(data) {
            const div = document.createElement('div');
            div.className = 'swiper-slide';
            div.innerHTML = `
                <div class="card-layer-bg">
                    <div class="bg-half" style="background:${data.c}"><div class="card-layer-overlay"></div></div>
                    <div class="bg-half" style="background:${data.c}"><div class="card-layer-overlay"></div></div>
                </div>
                <img src="${data.src}" class="main-img ${data.isVert?'fit-cover':''}">
            `;
            return div;
        }

        function tab(name, btn) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active-tab'));
            document.getElementById('view-' + name).classList.add('active-tab');
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function saveActive() {
            const activeSlide = document.querySelector('.active-tab .swiper-slide-active img');
            if(activeSlide) {
                const a = document.createElement('a');
                a.href = activeSlide.src; a.download = 'card.png'; a.click();
            }
        }
    </script>
</body>
</html>

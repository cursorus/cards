<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Карточки Финал (Fixed)</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root { 
            --bg: #050505; --accent: #fff; --pill: #1a1a1a; --gray: #666; 
            --nav-h: 60px; --radius: 30px; 
        }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); color: #fff; font-family: -apple-system, sans-serif; overflow: hidden; }
        .flex-center { display: flex; align-items: center; justify-content: center; flex-direction: column; height: 100%; }
        .hidden { display: none !important; }

        #loading-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 50px; height: 50px; border: 4px solid #333; border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }

        /* Навигация */
        .nav-container { position: fixed; bottom: 30px; left: 0; right: 0; display: flex; justify-content: center; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); pointer-events: none; }
        .nav-pill { pointer-events: auto; display: flex; background: var(--pill); border: 1px solid #333; height: var(--nav-h); border-radius: 40px; padding: 0 15px; align-items: center; gap: 5px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .nav-item { background: transparent; border: none; color: var(--gray); display: flex; flex-direction: column; align-items: center; justify-content: center; width: 60px; height: 100%; cursor: pointer; }
        .nav-item.active { color: var(--accent); }
        .nav-item span { font-size: 26px; }
        .nav-item p { font-size: 9px; margin: 0; font-weight: 700; text-transform: uppercase; margin-top: 2px; }

        /* Слайдер */
        .swiper { width: 320px; height: 480px; perspective: 1200px; overflow: visible; }
        .swiper-slide { border-radius: var(--radius); background: #111; overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.9); }
        
        /* Слои фона карточки */
        .card-layer-bg { position: absolute; inset: 0; display: flex; flex-direction: column; z-index: 1; border-radius: inherit; overflow: hidden; }
        .bg-half { flex: 1; width: 100%; position: relative; }
        
        .card-layer-overlay { 
            position: absolute; inset: 0; 
            background: url('cardbg.png') center/cover no-repeat; 
            z-index: 2; 
            opacity: 0.2; 
            mix-blend-mode: overlay;
            pointer-events: none;
            border-radius: inherit;
        }
        
        .main-img { position: relative; z-index: 5; width: 100%; height: 100%; opacity: 0; transition: opacity 0.6s; }
        .main-img.visible { opacity: 1; }
        .fit-cover { object-fit: cover; }
        .fit-contain { object-fit: contain; }

        .tab-content { position: absolute; inset: 0; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .tab-content.active-tab { opacity: 1; pointer-events: auto; }
        
        /* Теги */
        .tag-wrap { position: absolute; top: 60px; left: 0; right: 0; display: flex; justify-content: center; flex-wrap: wrap; gap: 8px; padding: 0 20px; z-index: 100; pointer-events: none; }
        .tag-btn { pointer-events: auto; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); color: #888; border: 1px solid #333; padding: 8px 16px; border-radius: 20px; font-size: 11px; font-weight: 800; text-transform: uppercase; }
        .tag-btn.active { background: var(--accent); color: #000; border-color: var(--accent); }

        /* Пикод */
        #auth-screen { z-index: 5000; position: fixed; inset: 0; background: #000; }
        .key { width: 70px; height: 70px; border-radius: 50%; background: #151515; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; }
        .key:active { transform: scale(0.9); }
        .dots { display: flex; gap: 15px; margin-bottom: 40px; }
        .dot { width: 12px; height: 12px; border: 2px solid #333; border-radius: 50%; }
        .dot.filled { background: #fff; border-color: #fff; }
        
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading-overlay" class="hidden">
        <div class="spinner"></div>
        <div id="load-text" style="margin-top:20px; font-size:12px; color:#666; font-family:monospace;">ЗАГРУЗКА...</div>
    </div>

    <div id="auth-screen" class="flex-center">
        <div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
        <div style="display:grid; grid-template-columns:repeat(3, 80px); gap:20px;">
            <div class="key" onclick="kp(1)">1</div><div class="key" onclick="kp(2)">2</div><div class="key" onclick="kp(3)">3</div>
            <div class="key" onclick="kp(4)">4</div><div class="key" onclick="kp(5)">5</div><div class="key" onclick="kp(6)">6</div>
            <div class="key" onclick="kp(7)">7</div><div class="key" onclick="kp(8)">8</div><div class="key" onclick="kp(9)">9</div>
            <div></div><div class="key" onclick="kp(0)">0</div><div class="key" onclick="kp('C')">×</div>
        </div>
    </div>

    <div id="app" class="hidden">
        <div id="view-main" class="tab-content active-tab flex-center">
            <div class="swiper" id="sw-main"><div class="swiper-wrapper" id="wr-main"></div></div>
        </div>

        <div id="view-tags" class="tab-content flex-center">
            <div class="tag-wrap" id="tag-cloud"></div>
            <div class="swiper" id="sw-tags"><div class="swiper-wrapper" id="wr-tags"></div></div>
        </div>

        <div id="view-up" class="tab-content flex-center">
             <div onclick="document.getElementById('fIn').click()" style="width:260px; height:380px; border:2px dashed #333; border-radius:30px; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#555; cursor:pointer;">
                <span class="material-symbols-rounded" style="font-size:40px">add</span>
                <span style="font-size:12px; margin-top:10px; font-weight:700;">ВЫБРАТЬ ФАЙЛЫ</span>
             </div>
             <input type="file" id="fIn" hidden multiple accept="image/*">
        </div>

        <div class="nav-container">
            <div class="nav-pill">
                <button class="nav-item active" onclick="tab('main', this)"><span class="material-symbols-rounded">layers</span><p>Сток</p></button>
                <button class="nav-item" onclick="tab('tags', this)"><span class="material-symbols-rounded">tag</span><p>Теги</p></button>
                <button class="nav-item" onclick="tab('up', this)"><span class="material-symbols-rounded">upload</span><p>Стык</p></button>
                <div style="width:1px; height:25px; background:#333; margin:0 5px;"></div>
                <button class="nav-item" onclick="saveActive()"><span class="material-symbols-rounded">download</span><p>Сейв</p></button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script>
        const PIN_HASH = "03ac674216f3e15c761ee1a5e255f067953623c8b388b4459e13f978d7c846f4"; 
        const ALLOWED_TAGS = ["funny", "arguments", "narkoman", "parents", "art", "personal", "screenshot"]; 

        let pin = "", cache = [], swMain, swTags;

        function kp(n) {
            if(n==='C') pin = ""; else if(pin.length < 4) pin += n;
            document.querySelectorAll('.dot').forEach((d,i) => d.className = i < pin.length ? 'dot filled' : 'dot');
            if(pin.length === 4) checkPin();
        }
        
        function checkPin() {
            const hash = CryptoJS.SHA256(pin).toString();
            if(hash === PIN_HASH) {
                document.getElementById('auth-screen').classList.add('hidden');
                startApp();
            } else {
                pin = ""; 
                document.querySelectorAll('.dot').forEach(d => d.className = 'dot');
            }
        }

        async function startApp() {
            document.getElementById('fIn').addEventListener('change', handleUpload);
            document.getElementById('app').classList.remove('hidden');
            // Здесь можно добавить загрузку существующих файлов, если они есть
        }

        async function handleUpload(e) {
            const files = Array.from(e.target.files);
            if(!files.length) return;
            
            document.getElementById('loading-overlay').classList.remove('hidden');
            for(let file of files) {
                const reader = new FileReader();
                const promise = new Promise(resolve => {
                    reader.onload = async (ev) => {
                        await addCardToCache(ev.target.result, file.name);
                        resolve();
                    };
                });
                reader.readAsDataURL(file);
                await promise;
            }
            
            refreshSwiper('main');
            renderTagButtons();
            tab('main', document.querySelector('.nav-item'));
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        async function addCardToCache(src, filename) {
            const meta = await analyzeImage(src);
            const foundTags = ALLOWED_TAGS.filter(tag => filename.toLowerCase().includes(tag));
            const item = { id: filename, src, ...meta, tags: foundTags };
            cache.push(item);
            document.getElementById('wr-main').appendChild(buildSlide(item));
        }

        function analyzeImage(src) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    let isVert = img.height > img.width * 1.1;
                    const cvs = document.createElement('canvas');
                    const ctx = cvs.getContext('2d');
                    cvs.width = 1; cvs.height = 1;
                    ctx.drawImage(img, 0, 0, 1, 1);
                    const [r,g,b] = ctx.getImageData(0,0,1,1).data;
                    const color = `rgb(${r},${g},${b})`;
                    resolve({ isVert, tc: color, bc: color });
                };
                img.src = src;
            });
        }

        function buildSlide(data) {
            const div = document.createElement('div');
            div.className = 'swiper-slide';
            let bgHTML = `<div class="card-layer-bg">
                <div class="bg-half" style="background:${data.tc}"><div class="card-layer-overlay"></div></div>
                <div class="bg-half" style="background:${data.bc}"><div class="card-layer-overlay"></div></div>
            </div>`;
            div.innerHTML = `${bgHTML}<img src="${data.src}" class="main-img visible ${data.isVert?'fit-cover':'fit-contain'}">`;
            return div;
        }

        function refreshSwiper(type) {
            if(type === 'main') {
                if(swMain) swMain.destroy();
                swMain = new Swiper('#sw-main', { effect: "cards", grabCursor: true });
            } else {
                if(swTags) swTags.destroy();
                swTags = new Swiper('#sw-tags', { effect: "cards", grabCursor: true });
            }
        }

        function renderTagButtons() {
            const c = document.getElementById('tag-cloud');
            c.innerHTML = '';
            const usedTags = [...new Set(cache.flatMap(x => x.tags))];
            usedTags.forEach(t => {
                const b = document.createElement('button');
                b.className = 'tag-btn';
                b.innerText = t;
                b.onclick = () => filterByTag(t, b);
                c.appendChild(b);
            });
        }

        function filterByTag(tag, btn) {
            btn.classList.toggle('active');
            const activeTags = Array.from(document.querySelectorAll('.tag-btn.active')).map(b => b.innerText);
            const wr = document.getElementById('wr-tags');
            wr.innerHTML = '';
            const filtered = cache.filter(item => activeTags.every(t => item.tags.includes(t)));
            filtered.forEach(item => wr.appendChild(buildSlide(item)));
            refreshSwiper('tags');
        }

        function tab(name, btn) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active-tab'));
            document.getElementById('view-'+name).classList.add('active-tab');
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function saveActive() {
            const isMain = document.getElementById('view-main').classList.contains('active-tab');
            const sw = isMain ? swMain : swTags;
            if(!sw || sw.slides.length === 0) return;
            const img = sw.slides[sw.activeIndex].querySelector('img');
            const a = document.createElement('a');
            a.href = img.src; a.download = 'card.png'; a.click();
        }
    </script>
</body>
</html>
